$(document).ready(function () {
    InizitializeControls();
    InitializeChosen();


    $(document).on('click', '#HideInHistory', function () {
        getFamilyBrochure()
    });

    $(document).on('click', '.myBrochure', function () {
        var id = $(this).attr('rowID');
        var href = $(this).attr('href');
        GetBrochureByProduct(id, href);
    });

    $(document).on('click', '.submyBrochure', function () {
        var id = $(this).attr('rowID');
        //GetBrochureByProduct(id);
    });
    componentHandler.upgradeAllRegistered();
}); /// fin de document ready

function getFamilyBrochure() {
    $('#segundoTab').empty();
    $.ajax({
        type: "POST",
        url: "/Home/GetProductTypeFamily",
        data: {},
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (result) {
            //recorro el listado de tipos de brochure
            $.each(result, function (idx, obj) {
                //formulo el id del registro
                var rowId = "#" + obj.name.toLowerCase() + "-tab";
                var element = "<li class='nav-item'>";
                element += "<a class='nav-link myBrochure' rowID='" + obj.Value + "' id='" + obj.name.toLowerCase() + "-tab' data-toggle='tab' href='#" + obj.name.toLowerCase() + "' role='tab' aria-controls='" + obj.name.toLowerCase() + "' aria-selected='true'>" + obj.name + "</a>";
                element += "</li>";

                $('#segundoTab').append(element);
                if (obj.Value == 1) {
                    $(rowId).addClass('active');
                    GetBrochureByProduct(obj.Value);
                }

            });

            var compare = "<li class='nav-item'>"
            compare += "<a class='nav-link' id='tblComparativos-tab' data-toggle='tab' href='#tblComparativos' role='tab' aria-controls='tblComparativos' aria-selected='false'>Tabla comparativos</a>";
            compare += "</li>";
            $('#segundoTab').append(compare);
        },
        failure: function (response) {
            showError([response.responseText], "Error cargando el listado de Brochure");
        },
        error: function (response) {
            showError([response.responseText], "Error cargando el listado de Brochure");
        }
    });
}

function GetBrochureByProduct(ProductFamilyId, href) {

    $.ajax({
        url: "/Home/GetBrochureByProduct",
        dataType: 'json',
        async: false,
        data: { productTypeID: ProductFamilyId },
        success: function (result) {
            //recorro el listado de tipos de brochure

            $('#dvtabContent').empty();
            $('#tercerTab').empty();

            var idDiv = href ? href.replace("#", "") : "ley";
            var elementDiv = "<div class='tab-pane fade show active' id='" + idDiv + "' role='tabpanel' aria-labelledby='" + idDiv + "-tab'>";
            var elementUl = "<ul class='nav nav-tabs justify-content-center' id='tercerTab' role='tablist'>";

            var firstTabSelected = true;
            var callCoveragesTypes = false;

            var objidBk = 0;
            var NameCleanBK = "";

            $.each(result, function (idx, obj) {

                var element = "<li class='nav-item'>";
                var rowId = ""
                var Name = obj.Name.toLowerCase().replace(" ", "").replace("á", "a").replace("é", "a").replace("í", "a").replace("ó", "a").replace("ú", "a");
                var NameClean = obj.Name.toLowerCase().replace(" ", "").replace("á", "a").replace("é", "a").replace("í", "a").replace("ó", "a").replace("ú", "a");

                NameClean = NameClean.replace(" ", "");

                if (firstTabSelected) {

                    rowId = "#" + NameClean.toLowerCase() + "i-tab";
                    element += "<a class='nav-link submyBrochure active' rowID='" + obj.Id + "' id='" + rowId.replace("#", "") + "' data-toggle='tab' href='#" + NameClean + "i' role='tab' aria-controls='" + NameClean + "i' aria-selected='true'>" + obj.Name + "</a>";

                    objidBk = obj.Id;
                    NameCleanBK = NameClean;

                    firstTabSelected = false;
                    callCoveragesTypes = true;
                }
                else if (obj.Id == 12) {

                    rowId = "#" + NameClean.toLowerCase() + "P-tab";
                    element += "<a class='nav-link submyBrochure' rowID='" + obj.Id + "' id='" + rowId.replace("#", "") + "' data-toggle='tab' href='#" + NameClean + "P' role='tab' aria-controls='" + NameClean + "P' aria-selected='false'>" + obj.Name + "</a>";

                } else {

                    rowId = "#" + NameClean.toLowerCase() + "-tab";
                    element += "<a class='nav-link submyBrochure' rowID='" + obj.Id + "' id='" + rowId.replace("#", "") + "' data-toggle='tab' href='#" + NameClean + "' role='tab' aria-controls='" + NameClean + "' aria-selected='false'>" + obj.Name + "</a>";
                }

                element += "</li>";
                elementUl += element;
            });

            elementUl += "</ul>";
            elementDiv += "</div>";

            $('#dvtabContent').append(elementDiv);
            $("#" + idDiv).append(elementUl);

            if (callCoveragesTypes) {
                getCoverageTypesBrochure(objidBk, NameCleanBK);


            }
        },
        failure: function (response) {
            showError([response.responseText], "Error cargando el listado de Brochure");
        },
        error: function (response) {
            showError([response.responseText], "Error cargando el listado de Brochure");
        }
    });
}

function createTableCoverageHeader(coverageName, NameClean) {

    //$('#dvTabContentTableCoverages').empty();

    //var elementDiv = "<div class='tab-pane fade show active' id='" + NameClean + "' role='tabpanel' aria-labelledby='" + NameClean + "-tab'>";
    //var elementDiv2 = "<div class='col-12 row float-none m-auto mdl-shadow--2dp'>";
    //var tblCoverages = "<table id='coverageTable' class='table table-responsive table-striped'>";
    //var tblHeaderTr = "<thead> <tr class='coverageTypes'>";


    var row = "";
    //var tableHeader = $('#coverageTable thead');
    //tableHeader.empty();

    //row = "<tr class='coverageTypes'></tr>";

    row += "<tr class='bg-info mdl-color-text--white'>";
    row += "<th align='left' class='c1'><span>" + coverageName + "</span></th>";
    row += "<th align='center' class='c2'><span>Límite</span></th>";
    row += "<th align='center' class='c2'><span>Límite</span></th>";
    row += "<th align='center' class='c2'><span>Límite</span></th>";
    row += "<th align='center' class='c2'><span>Límite</span></th>";
    row += "<th align='center' class='c2'><span>Límite</span></th>";
    row += "</tr>";

    //tblHeaderTr += row;
    //tblHeaderTr += "</tr> </thead>";

    //tableHeader.append(row);

    //elementDiv2 += tblCoverages;

    //elementDiv2 += "</div>";

    //elementDiv += elementDiv2;
    //elementDiv += "</div>";

}

function getCoverageTypesBrochure(ProductTypeBrochureId, NameClean) {
    $.ajax({
        url: "/Home/GetCoverageTypesBrochure",
        dataType: 'json',
        async: false,
        data: { ProductTypeBrochureId: ProductTypeBrochureId },
        success: function (result) {

            var tblReturned = createNewTableWithHeader(NameClean, result);

            getCoverageDetailBrochure(ProductTypeBrochureId, tblReturned);

            //$('#dvTabContentTableCoverages').empty();
            //var row = "";

            //var elementDiv = "<div class='tab-pane fade show active' id='" + NameClean + "' role='tabpanel' aria-labelledby='" + NameClean + "-tab'>";
            //var elementDiv2 = "<div class='col-12 row float-none m-auto mdl-shadow--2dp'>";

            //var tblCoverages = $("<table>").addClass("table table-responsive table-striped"); // "<table id='coverageTable' class='table table-responsive table-striped'>";
            ////var tblHeaderTr = "<thead> <tr class='coverageTypes'>";
            //var tblHeaderTr = "<thead> <tr class='coverageTypes'>";


            //row += "<tr class='bg-info mdl-color-text--white'>";
            //row += "<th align='left' class='c1'><span>" + coverageName + "</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "</tr>";

            //tblHeaderTr += row;
            //tblHeaderTr += "</tr> </thead>";

            //tblCoverages = + tblHeaderTr;


            ////recorro el primer row que tiene el thead para agregar las columnas con los tipos de coberturas
            //var $row = $('#coverageTable thead tr.coverageTypes');
            //$row.empty();
            //$row.append("<th align='left' class='c1'>&nbsp;</th>");
            ////recorriendo los tipos de coverturas
            //$.each(result, function (idx, obj) {
            //    $row.append("<th align='center' class='bg-info mdl-color-text--white'><span>" + obj.name + "</span></th>");
            //});



            //elementDiv2 += tblCoverages;

            //elementDiv2 += "</div>";

            //elementDiv += elementDiv2;
            //elementDiv += "</div>";


        },
        failure: function (response) {
            showError([response.responseText], "Error cargando los tipos de coberturas de Brochure");
        },
        error: function (response) {
            showError([response.responseText], "Error cargando los tipos de coberturas de Brochure");
        }
    });
}

function createNewTableWithHeader(NameClean, coveragesLimitsHeaders) {

    var dvTabContentTableCoverages = $("<div>").attr("id", "dvTabContentTableCoverages").addClass("tab-content");

    var row = "";

    var elementDiv = $("<div>").attr("id", "" + NameClean + "").attr("role", "tabpanel").attr("aria-labelledby", "" + NameClean + "-tab").addClass("tab-pane fade show active");
    var elementDiv2 = $("<div>").addClass("col-12 row float-none m-auto mdl-shadow--2dp");

    var tblCoverages = $("<table>").attr('id','coverageTable').addClass("table table-responsive table-striped"); // "<table id='coverageTable' class='table table-responsive table-striped'>";

    var tblHeader = $('<thead>');

    var tblHeaderTrRow = $('<tr>').addClass('coverageTypes');

    var tblHeaderTrRowHeader = $('<th>').css('align', 'left').addClass('c1').text("");//&nbsp;
    tblHeaderTrRow.append(tblHeaderTrRowHeader);

    //Dinamicamente traer los limites de las coberturas
    $.each(coveragesLimitsHeaders, function (idx, obj) {
        var tblHeaderTrRowHeaderDyna = $('<th>').css('align', 'center').addClass('bg-info mdl-color-text--white');
        $("<span>" + obj.name + "</span>").prependTo(tblHeaderTrRowHeaderDyna);
        tblHeaderTrRow.append(tblHeaderTrRowHeaderDyna);
    });
    //

    tblHeader.append(tblHeaderTrRow);

    tblCoverages.append(tblHeader);

    elementDiv2.append(tblCoverages);
    elementDiv.append(elementDiv2);

    dvTabContentTableCoverages.append(elementDiv);

    $('#dvtabContent').append(dvTabContentTableCoverages);

    return tblCoverages;
}


function getCoverageDetailBrochure(ProductTypeBrochureId, tblCoverages) {
    $.ajax({
        url: "/Home/GetCoverageDetailBrochure",
        dataType: 'json',
        async: false,
        data: { CoverageBrochureId: ProductTypeBrochureId },
        success: function (result) {

            var arrUsedCovTypes = [];
            
            if (result.result) {

                var tblHeaderTrRowNew = $('<tr>').addClass('bg-info mdl-color-text--white');
                
                var rowCount = $('#' + tblCoverages.attr("id") + '> thead >tr.coverageTypes > th').length;
                var oneTIme = false;
                var tblDetailRow = $('<tr>');

                var realHeader = $('#' + tblCoverages.attr("id") + '> thead');

                $.each(result.result, function (idx, obj) {

                    if (arrUsedCovTypes.indexOf(obj.CoverageType) == -1) {

                        var tblHeaderTrcovname = $('<th>').css('align', 'left').addClass('c1');
                        $("<span>" + obj.CoverageType + "</span>").prependTo(tblHeaderTrcovname);
                        tblHeaderTrRowNew.append(tblHeaderTrcovname);
                        arrUsedCovTypes.push(obj.CoverageType);

                        if (!oneTIme) {

                            for (var i = 1; i < rowCount; i++) {

                                var tblHeaderTrRowNewFixed = $('<th>').css('align', 'center').addClass('c2');
                                $("<span>Límite</span>").prependTo(tblHeaderTrRowNewFixed);
                                tblHeaderTrRowNew.append(tblHeaderTrRowNewFixed);
                            }
                            oneTIme = true;
                            //tblCoverages.append(tblHeaderTrRowNew);
                            realHeader.append(tblHeaderTrRowNew);
                        }                       
                    }

                    var tblDetailRow = $('<tr>');

                    var tblDetailRowTd = $('<td>').text(obj.CoverageName);

                    for (var i = 1; i < rowCount; i++) {

                        var tblDetailRowTdVal = $('<td>').text(obj.Value);
                        tblDetailRow.append(tblDetailRowTdVal);                      
                    }

                    var tblDetailRowTdVal = $('<td>').text(obj.Value);
                    /*var tblDetailRowTd1 = $('<td>').addClass('bg-info mdl-color-text--white').text(obj.CoverageName);
                    var tblDetailRowTd2 = $('<td>').addClass('bg-info mdl-color-text--white').text(obj.CoverageName);
                    var tblDetailRowTd3 = $('<td>').addClass('bg-info mdl-color-text--white').text(obj.CoverageName);
                    var tblDetailRowTd4 = $('<td>').addClass('bg-info mdl-color-text--white').text(obj.CoverageName);
                    var tblDetailRowTd5 = $('<td>').addClass('bg-info mdl-color-text--white').text(obj.CoverageName);
                    var tblDetailRowTd5 = $('<td>').addClass('bg-info mdl-color-text--white').text(obj.CoverageName);
                    */

                    tblDetailRow.append(tblDetailRowTd);
                    

                    tblCoverages.append(tblDetailRow);

                });

                
                




            }


            //$.each(result, function (idx, obj) {
            //    var tblHeaderTrRowHeaderDyna = $('<th>').css('align', 'center').addClass('bg-info mdl-color-text--white');
            //    $("<span>" + obj.name + "</span>").prependTo(tblHeaderTrRowHeaderDyna);
            //    tblHeaderTrRow.append(tblHeaderTrRowHeaderDyna);
            //});

            //$('#dvTabContentTableCoverages').empty();
            //var row = "";

            //var elementDiv = "<div class='tab-pane fade show active' id='" + NameClean + "' role='tabpanel' aria-labelledby='" + NameClean + "-tab'>";
            //var elementDiv2 = "<div class='col-12 row float-none m-auto mdl-shadow--2dp'>";

            //var tblCoverages = $("<table>").addClass("table table-responsive table-striped"); // "<table id='coverageTable' class='table table-responsive table-striped'>";
            ////var tblHeaderTr = "<thead> <tr class='coverageTypes'>";
            //var tblHeaderTr = "<thead> <tr class='coverageTypes'>";


            //row += "<tr class='bg-info mdl-color-text--white'>";
            //row += "<th align='left' class='c1'><span>" + coverageName + "</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "<th align='center' class='c2'><span>Límite</span></th>";
            //row += "</tr>";

            //tblHeaderTr += row;
            //tblHeaderTr += "</tr> </thead>";

            //tblCoverages = + tblHeaderTr;


            ////recorro el primer row que tiene el thead para agregar las columnas con los tipos de coberturas
            //var $row = $('#coverageTable thead tr.coverageTypes');
            //$row.empty();
            //$row.append("<th align='left' class='c1'>&nbsp;</th>");
            ////recorriendo los tipos de coverturas
            //$.each(result, function (idx, obj) {
            //    $row.append("<th align='center' class='bg-info mdl-color-text--white'><span>" + obj.name + "</span></th>");
            //});



            //elementDiv2 += tblCoverages;

            //elementDiv2 += "</div>";

            //elementDiv += elementDiv2;
            //elementDiv += "</div>";


        },
        failure: function (response) {
            showError([response.responseText], "Error cargando los tipos de coberturas de Brochure");
        },
        error: function (response) {
            showError([response.responseText], "Error cargando los tipos de coberturas de Brochure");
        }
    });
}
