using Newtonsoft.Json;
using Statetrust.Framework.Security.Bll.Item;
using STL.POS.Data;
using STL.POS.Frontend.Security.SecurityProvider;
using STL.POS.Frontend.Web.Areas.Security.Models;
using STL.POS.Frontend.Web.Helpers;
using STL.POS.THProxy;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Web;
using System.Web.Configuration;
using System.Web.Mvc;
using System.Web.Security;
using Statetrust.Framework.Core.Base;
using Statetrust.Framework.Web.Mvc.WebParts.Controllers;
using STL.POS.Frontend.Web.Controllers;
using STL.POS.AgentWSProxy;
using STL.POS.AgentWSProxy.AgentService;

namespace STL.POS.Frontend.Web.Areas.Security.Controllers
{

    public class AccountController : BaseController
    {
        private IAuthenticationProvider authProvider;
        private ITHProxy thunderHeadProxy;
        private IAgentProxy agentProxy;

        public AccountController(IAuthenticationProvider iauth, PosModel da, ITHProxy thProxy, IAgentProxy aProxy)
            : base(da)
        {
            authProvider = iauth;
            thunderHeadProxy = thProxy;
            agentProxy = aProxy;
        }

        [AllowAnonymous]
        public ActionResult RedirectToVo(string path, string appname, string tab)
        {
            var addInfo = new AdditionalInfo
            {
                CompanyId = Usuario.CurrentCompanyId, //Nombre de la compañía de la cual se quiere ver la data (Life o Atlantica)
                Language = Usuario.CurrentLanguageKey, //Idioma en el que quiere que se vea la aplicación a acceder.
                AppName = appname,
                RedirectUrl = path,
                RedirectTab = tab
            };

            var data = GenerateToken(Usuario.UserID, addInfo); //Genera un nuevo Token y se le pasa el ID del Usuario, el WebControl que lo llamo para leer los parámetros de aplicación y el Additional info para saber la compañía y el idioma.

            FormsAuthentication.SignOut();

            // if (data.Status) //Devuelve True en caso de que el logueo haya sido exitoso.
            return Redirect(data.UrlPath);
            //else
            //    return RedirectToAction("Login", "Account", new { Area = "Security", unauthorizedAccess = true, showUserCreatedSuccess = false });
        }

        public ActionResult LoginFromVOUserPass(string username, string password)
        {

            var userId = 0;

            string token = "NO TOKEN";
            var addInfo = new AdditionalInfo
            {
                CompanyId = 2, //Nombre de la compañía de la cual se quiere ver la data (Life o Atlantica)
                Language = "es" //Idioma en el que quiere que se vea la aplicación a acceder.
            };
            if (Login(username, password, ref userId))
            {
                SetLoginInformation();
                var obj = GenerateToken(userId, addInfo);
                token = obj.token;
            }
            return Content(token);
        }

        public ActionResult LoginFromVODummy()
        {
            var userId = 0;
            var appId = 0;
            var loginName = "acatellani";
            var email = "agustin.catellani@diveria.com";
            var username = "acatellani";

            var dbUser = (from c in dataAccess.Users
                          where c.Username == loginName
                          && c.UserOrigin == UserOrigins.VO
                          select c).FirstOrDefault();

            var now = DateTime.Now;
            if (dbUser == null)
            {

                dbUser = new Data.User()
                {
                    DateCreated = now,
                    Email = email,
                    LastDateModified = now,
                    //Name = Usuario.FirstName,
                    LastLogin = now,
                    //Surname = Usuario.LastName,
                    Username = loginName,
                    UserOrigin = UserOrigins.VO,
                    UserStatus = UserStatus.Active
                };
                var str = string.Empty;
                dataAccess.Users.Add(dbUser);
            }
            dbUser.LastLogin = now;
            dataAccess.SaveChanges();

            FormsAuthentication.SetAuthCookie(username, true);
            return RedirectToAction("QuotationSearch", new { currentUserName = username, Controller = "Home", Area = string.Empty });
        }

        private void CheckDbUser(string loginName, string email)
        {
            var dbUser = (from c in dataAccess.Users
                          where c.Username == loginName
                          && c.UserOrigin == UserOrigins.VO
                          select c).FirstOrDefault();

            var now = DateTime.Now;
            if (dbUser == null)
            {

                dbUser = new Data.User()
                {
                    DateCreated = now,
                    Email = email,
                    LastDateModified = now,
                    Name = Usuario.FirstName,
                    LastLogin = now,
                    Surname = Usuario.LastName,
                    Username = loginName,
                    UserOrigin = UserOrigins.VO,
                    UserStatus = UserStatus.Active
                };
                switch (Usuario.UserType)
                {
                    case Statetrust.Framework.Security.Bll.Usuarios.UserTypeEnum.Assistant:
                        dbUser.UserType = UserType.Subscriptor;
                        break;
                    case Statetrust.Framework.Security.Bll.Usuarios.UserTypeEnum.Agent:
                        dbUser.UserType = UserType.Agent;
                        break;
                    default:
                        dbUser.UserType = UserType.WebUser;
                        break;
                }

                var str = string.Empty;
                authProvider.CreateUser(dbUser, out str);
            }
            else
            {
                dbUser.LastLogin = now;
                dataAccess.SaveChanges();
            }
        }

        public ActionResult LoginFromVO(string token)
        {
            var userId = 0;
            var appId = 0;
            var username = string.Empty;
            var loginName = string.Empty;
            var email = string.Empty;
            if (LoginToken(token, ref userId, ref appId, ref username, ref email, ref loginName))
            {
                var dbUser = (from c in dataAccess.Users
                              where c.Username == loginName
                              && c.UserOrigin == UserOrigins.VO
                              select c).FirstOrDefault();

                var now = DateTime.Now;
                if (dbUser == null)
                {

                    dbUser = new Data.User()
                    {
                        DateCreated = now,
                        Email = email,
                        LastDateModified = now,
                        Name = Usuario.FirstName,
                        LastLogin = now,
                        Surname = Usuario.LastName,
                        Username = loginName,
                        UserOrigin = UserOrigins.VO,
                        UserStatus = UserStatus.Active
                    };
                    var str = string.Empty;
                    authProvider.CreateUser(dbUser, out str);
                }
                else
                {
                    dbUser.LastLogin = now;
                    dataAccess.SaveChanges();
                }

                FormsAuthentication.SetAuthCookie(username, true);
                return RedirectToAction("QuotationSearch", new { Controller = "Home", Area = string.Empty });
            }
            else
            {
                return RedirectToAction("Login", "Account", new { Area = "Security", unauthorizedAccess = true, showUserCreatedSuccess = false });
            }

        }

        [AllowAnonymous]
        public ActionResult STFLogin()
        
        {
            var controller = "Home";
            var action = "Index";

            if (WebConfigurationManager.AppSettings["ApplySecurity"].ToString(CultureInfo.InvariantCulture) == "false")
            {
                var userId = 0;
                string userLogin = "mamercedes";//defaultuser                
                if (!Login(userLogin, "outiiz/77lQ=", ref userId))
                {
                    return RedirectToAction(action, controller);
                }

                SetLoginInformation();

                CheckDbUser(Usuario.UserLogin, Usuario.Email);
                FormsAuthentication.SetAuthCookie(Usuario.UserLogin, true);
            }
            else
            {
                if (Request.QueryString.Count > 0)
                {
                    var secToken = Request.QueryString[0];
                    var userId = 0;
                    var applicationId = 0;
                    var username = string.Empty;
                    var loginName = string.Empty;
                    var email = string.Empty;
                    if (!Login(secToken, ref userId, ref applicationId)) //, ref username, ref email, ref loginName))
                        return RedirectToAction(action, controller);


                    SetLoginInformation();

                    CheckDbUser(Usuario.UserLogin, email);
                    //action = "QuotationSearch";
                    FormsAuthentication.SetAuthCookie(Usuario.UserLogin, true);
                }
                else
                    return Redirect(WebConfigurationManager.AppSettings["SecurityLogin"].ToString(CultureInfo.InvariantCulture));
            }

            return RedirectToAction(action, new { currentUserName = Usuario.UserLogin, Controller = controller, Area = string.Empty });
        }

        public ActionResult LogoutPOS()
        {
            FormsAuthentication.SignOut();
            //Session.Abandon();
            //ViewBag.UnauthorizedAccess = false;
            return RedirectToAction("Index", "Home");
        }
    }

}